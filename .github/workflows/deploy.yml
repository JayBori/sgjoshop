name: build-push-deploy-aci

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      RG: sgjo-test-shop-rg
      LOC: koreacentral
      ACR: sgjoshop

      FRONT_NAME: sgjo-aci-front
      BACK_NAME: sgjo-aci-back
      DB_NAME: sgjo-aci-db

      FRONT_DNS: sgjo-front
      BACK_DNS: sgjo-back
      DB_DNS: sgjo-db

      FRONT_DOMAIN: sgjo.shop

      DB_USER: shopuser
      DB_DBNAME: shopdb

      SA: sgjoshopstorekrc01

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create RG (if not exists)
        run: |
          set -e
          az group create -n $RG -l $LOC

      - name: Ensure ACR exists
        run: |
          set -e
          az acr show -n $ACR -g $RG >/dev/null 2>&1 || az acr create -n $ACR -g $RG --sku Basic
          az acr update -n $ACR --admin-enabled true

      - name: ACR Login
        run: |
          set -e
          az acr login -n $ACR

      - name: Get ACR credentials
        run: |
          set -e
          ACR_USER=$(az acr credential show -n $ACR --query username -o tsv)
          ACR_PASS=$(az acr credential show -n $ACR --query "passwords[0].value" -o tsv)
          echo "ACR_USER=$ACR_USER" >> $GITHUB_ENV
          echo "ACR_PASS=$ACR_PASS" >> $GITHUB_ENV

      - name: Ensure Storage Account + File Shares (idempotent)
        run: |
          set -e
          az storage account show -g $RG -n $SA >/dev/null 2>&1 || \
          az storage account create -g $RG -n $SA -l $LOC --sku Standard_LRS --kind StorageV2

          SA_KEY=$(az storage account keys list -g $RG -n $SA --query "[0].value" -o tsv)
          echo "SA_KEY=$SA_KEY" >> $GITHUB_ENV

          az storage share create --account-name $SA --account-key $SA_KEY --name pgdata --quota 10
          az storage share create --account-name $SA --account-key $SA_KEY --name caddydata --quota 1
          az storage share create --account-name $SA --account-key $SA_KEY --name appdata --quota 10


      - name: Build & Push backend
        run: |
          set -e
          BACK_TAG=$ACR.azurecr.io/shop-backend:${{ github.sha }}
          docker build -t $BACK_TAG ./backend
          docker push $BACK_TAG
          echo "BACK_TAG=$BACK_TAG" >> $GITHUB_ENV

      - name: Build & Push frontend
        run: |
          set -e
          FRONT_TAG=$ACR.azurecr.io/shop-frontend:${{ github.sha }}
          docker build -t $FRONT_TAG ./frontend
          docker push $FRONT_TAG
          echo "FRONT_TAG=$FRONT_TAG" >> $GITHUB_ENV

      - name: Mirror postgres:16 to ACR (retry + fail fast)
        run: |
          set -e
          PG_IMAGE=$ACR.azurecr.io/library/postgres:16

          for i in 1 2 3 4 5; do
            echo "Pull attempt $i for postgres:16..."
            if docker pull postgres:16; then
              break
            fi
            sleep $((i*10))
            if [ "$i" -eq 5 ]; then
              echo "Failed to pull postgres:16 from Docker Hub after retries"
              exit 1
            fi
          done

          docker tag postgres:16 $PG_IMAGE
          docker push $PG_IMAGE
          echo "PG_IMAGE=$PG_IMAGE" >> $GITHUB_ENV

      - name: Deploy DB (PostgreSQL) to ACI
        run: |
          set -e
          az container delete -g $RG -n $DB_NAME --yes >/dev/null 2>&1 || true

          az container create \
            -g $RG -n $DB_NAME -l $LOC \
            --os-type Linux \
            --image $PG_IMAGE \
            --registry-login-server $ACR.azurecr.io \
            --registry-username $ACR_USER \
            --registry-password $ACR_PASS \
            --dns-name-label $DB_DNS \
            --ports 5432 \
            --cpu 1 \
            --memory 2 \
            --environment-variables \
              POSTGRES_USER=$DB_USER \
              POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }} \
              POSTGRES_DB=$DB_DBNAME \
              PGDATA=/var/lib/postgresql/data/pgdata \
            --azure-file-volume-account-name $SA \
            --azure-file-volume-account-key $SA_KEY \
            --azure-file-volume-share-name pgdata \
            --azure-file-volume-mount-path /var/lib/postgresql/data \
            --restart-policy Never

      - name: Wait for DB and init data
        run: |
          set -e
          echo "Waiting for DB to be Running..."
          for i in 1 2 3 4 5 6; do
            STATE=$(az container show -g $RG -n $DB_NAME --query instanceView.state -o tsv || echo "")
            echo "DB state: $STATE"
            if [ "$STATE" = "Running" ]; then
              break
            fi
            sleep 10
          done

          echo "DB logs (last 200 lines):"
          az container logs -g $RG -n $DB_NAME --tail 200 || true

      - name: Deploy backend to ACI
        run: |
          set -e
          az container delete -g $RG -n $BACK_NAME --yes >/dev/null 2>&1 || true

          DB_HOST="$DB_DNS.$LOC.azurecontainer.io"

          az container create \
            -g $RG -n $BACK_NAME -l $LOC \
            --os-type Linux \
            --image $BACK_TAG \
            --registry-login-server $ACR.azurecr.io \
            --registry-username $ACR_USER \
            --registry-password $ACR_PASS \
            --dns-name-label $BACK_DNS \
            --ports 8000 \
            --cpu 1 \
            --memory 1.5 \
            --environment-variables \
              DB_HOST=$DB_HOST \
              DB_PORT=5432 \
              DB_NAME=$DB_DBNAME \
              DB_USER=$DB_USER \
              DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
            --restart-policy Always \
            --azure-file-volume-account-name $SA \
            --azure-file-volume-account-key $SA_KEY \
            --azure-file-volume-share-name appdata \
            --azure-file-volume-mount-path /data \
            --environment-variables \
              DB_PATH=/data/shop.db



      - name: Deploy frontend (Caddy HTTPS) to ACI
        run: |
          set -e
          az container delete -g $RG -n $FRONT_NAME --yes >/dev/null 2>&1 || true

          API_BASE="http://$BACK_DNS.$LOC.azurecontainer.io:8000"

          az container create \
            -g $RG -n $FRONT_NAME -l $LOC \
            --os-type Linux \
            --image $FRONT_TAG \
            --registry-login-server $ACR.azurecr.io \
            --registry-username $ACR_USER \
            --registry-password $ACR_PASS \
            --dns-name-label $FRONT_DNS \
            --ports 80 443 \
            --cpu 1 \
            --memory 1.5 \
            --environment-variables \
              NEXT_PUBLIC_API_BASE=$API_BASE \
              FRONT_DOMAIN=$FRONT_DOMAIN \
            --azure-file-volume-account-name $SA \
            --azure-file-volume-account-key $SA_KEY \
            --azure-file-volume-share-name caddydata \
            --azure-file-volume-mount-path /data \
            --restart-policy Always

      - name: Print URLs
        run: |
          echo "DB:      $DB_DNS.$LOC.azurecontainer.io:5432"
          echo "BACKEND: http://$BACK_DNS.$LOC.azurecontainer.io:8000"
          echo "FRONT:   http://$FRONT_DNS.$LOC.azurecontainer.io (DNS 전)"
          echo "FRONT:   https://$FRONT_DOMAIN (DNS 연결 후)"
