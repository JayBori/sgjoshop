import osimport sqlite3from typing import Optionalfrom fastapi import FastAPI, HTTPException, Queryfrom starlette.middleware.cors import CORSMiddlewareapp = FastAPI()app.add_middleware(    CORSMiddleware,    allow_origins=["*"],    allow_credentials=True,    allow_methods=["*"]    ,allow_headers=["*"])DB_PATH = os.getenv("DB_PATH", "/data/shop.db")IMAGE_BASE = os.getenv("IMAGE_BASE", "")  # e.g., https://<sa>.blob.core.windows.net/product-imagesdef init_db():    os.makedirs(os.path.dirname(DB_PATH), exist_ok=True)    conn = sqlite3.connect(DB_PATH)    cur = conn.cursor()    cur.execute("""      CREATE TABLE IF NOT EXISTS products(        id INTEGER PRIMARY KEY AUTOINCREMENT,        sku TEXT,        name TEXT,        description TEXT,        price REAL,        image_url TEXT,        stock INTEGER DEFAULT 100      );    """)    # Cart table (anonymous cart via cart_id string)    cur.execute("""      CREATE TABLE IF NOT EXISTS carts(        cart_id TEXT,        product_id INTEGER,        qty INTEGER,        PRIMARY KEY(cart_id, product_id)      );    """)    # Orders tables    cur.execute("""      CREATE TABLE IF NOT EXISTS orders(        id INTEGER PRIMARY KEY AUTOINCREMENT,        cart_id TEXT,        total REAL,        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP      );    """)    cur.execute("""      CREATE TABLE IF NOT EXISTS order_items(        order_id INTEGER,        product_id INTEGER,        qty INTEGER,        price REAL      );    """)    # Ensure new columns exist for older DBs    cur.execute("PRAGMA table_info(products);")    cols = {row[1] for row in cur.fetchall()}    if "image_url" not in cols:        cur.execute("ALTER TABLE products ADD COLUMN image_url TEXT;")    if "stock" not in cols:        cur.execute("ALTER TABLE products ADD COLUMN stock INTEGER DEFAULT 100;")    # seed (í•œë²ˆë§Œ)    cur.execute("SELECT COUNT(*) FROM products;")    if cur.fetchone()[0] == 0:        def img(path, fallback):            return f"{IMAGE_BASE.rstrip('/')}/{path}" if IMAGE_BASE else fallback        seed_rows = [            ("SKU-001", "Classic Tee", "Soft cotton T-shirt in various colors.", 19.99, img("classic-tee.jpg", "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?w=600"), 200),            ("SKU-002", "Denim Jacket", "Timeless denim jacket with a modern fit.", 59.0, img("denim-jacket.jpg", "https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=600"), 80),            ("SKU-003", "Running Shoes", "Lightweight sneakers for everyday comfort.", 89.0, img("running-shoes.jpg", "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=600"), 120),            ("SKU-004", "Wireless Earbuds", "True wireless earbuds with noise isolation.", 49.0, img("wireless-earbuds.jpg", "https://images.unsplash.com/photo-1585386959984-a41552231658?w=600"), 150),            ("SKU-005", "Backpack", "Durable backpack with 15\" laptop sleeve.", 39.0, img("backpack.jpg", "https://images.unsplash.com/photo-1514477917009-389c76a86b68?w=600"), 60),            ("SKU-006", "Water Bottle", "Insulated stainless steel, 600ml.", 15.0, img("water-bottle.jpg", "https://images.unsplash.com/photo-1526404954014-2fa806b5aa47?w=600"), 300),        ]        cur.executemany(            "INSERT INTO products(sku,name,description,price,image_url,stock) VALUES (?,?,?,?,?,?)",            seed_rows,        )    conn.commit()    conn.close()@app.on_event("startup")def startup_event():    init_db()@app.get("/health")def health():    return {"ok": True, "db_path": DB_PATH}@app.get("/products")def products():    conn = sqlite3.connect(DB_PATH)    cur = conn.cursor()    cur.execute("SELECT id, sku, name, description, price, image_url, stock FROM products ORDER BY id;")    rows = cur.fetchall()    conn.close()    return [        {            "id": r[0],            "sku": r[1],            "name": r[2],            "description": r[3],            "price": r[4],            "image_url": r[5],            "stock": r[6],        }        for r in rows    ]@app.post("/init")def reseed():    conn = sqlite3.connect(DB_PATH)    cur = conn.cursor()    cur.execute("DELETE FROM products;")    def img(path, fallback):        return f"{IMAGE_BASE.rstrip('/')}/{path}" if IMAGE_BASE else fallback    seed_rows = [        ("SKU-001", "Classic Tee", "Soft cotton T-shirt in various colors.", 19.99, img("classic-tee.jpg", "https://images.unsplash.com/photo-1512436991641-6745cdb1723f?w=600"), 200),        ("SKU-002", "Denim Jacket", "Timeless denim jacket with a modern fit.", 59.0, img("denim-jacket.jpg", "https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=600"), 80),        ("SKU-003", "Running Shoes", "Lightweight sneakers for everyday comfort.", 89.0, img("running-shoes.jpg", "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=600"), 120),        ("SKU-004", "Wireless Earbuds", "True wireless earbuds with noise isolation.", 49.0, img("wireless-earbuds.jpg", "https://images.unsplash.com/photo-1585386959984-a41552231658?w=600"), 150),        ("SKU-005", "Backpack", "Durable backpack with 15\" laptop sleeve.", 39.0, img("backpack.jpg", "https://images.unsplash.com/photo-1514477917009-389c76a86b68?w=600"), 60),        ("SKU-006", "Water Bottle", "Insulated stainless steel, 600ml.", 15.0, img("water-bottle.jpg", "https://images.unsplash.com/photo-1526404954014-2fa806b5aa47?w=600"), 300),    ]    cur.executemany(        "INSERT INTO products(sku,name,description,price,image_url,stock) VALUES (?,?,?,?,?,?)",        seed_rows,    )    conn.commit()    conn.close()    return {"ok": True, "seeded": len(seed_rows)}@app.get("/cart")def get_cart(cart_id: str = Query(...)):    conn = sqlite3.connect(DB_PATH)    cur = conn.cursor()    cur.execute(        """        SELECT c.product_id, c.qty, p.name, p.price, p.image_url        FROM carts c        JOIN products p ON p.id = c.product_id        WHERE c.cart_id = ?        ORDER BY c.product_id        """,        (cart_id,),    )    rows = cur.fetchall()    conn.close()    items = [        {            "product_id": r[0],            "qty": r[1],            "name": r[2],            "price": r[3],            "image_url": r[4],            "line_total": r[1] * r[3],        }        for r in rows    ]    total = sum(i[1] * i[3] for i in rows)    count = sum(i[1] for i in rows)    return {"cart_id": cart_id, "count": count, "total": total, "items": items}@app.post("/cart/items")def add_cart_item(product_id: int, qty: int = 1, cart_id: str = Query(...)):    if qty <= 0:        raise HTTPException(400, "qty must be positive")    conn = sqlite3.connect(DB_PATH)    cur = conn.cursor()    # ensure product exists    cur.execute("SELECT id, stock FROM products WHERE id = ?", (product_id,))    row = cur.fetchone()    if not row:        conn.close()        raise HTTPException(404, "product not found")    # upsert    cur.execute(        "SELECT qty FROM carts WHERE cart_id=? AND product_id=?",        (cart_id, product_id),    )    existing = cur.fetchone()